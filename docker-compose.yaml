services:
  clc-registration-app:
    build: .
    expose:
      - "5000"  # expose internally; don't publish to host
    # Before nginx
    # ports:
    #   - "8080:5000"
    volumes:
      - type: bind
        source: .
        target: /src
    environment:
      # Don't set debug in production! else 1
      - FLASK_DEBUG=0
      # Enable debug logging for Python Benchling App. This is not native, specific to this example implementation
      - BENCHLING_APP_LOG_LEVEL=INFO #DEBUG
      # Client ID is not sensitive and is the same across all tenants, so could be hard-coded
      # You might choose to have two different Apps for dev vs prod, which would have different client IDs
      - CLIENT_ID=${CLIENT_ID_DEPLOY}
      - APP_DEFINITION_ID=${APP_DEFINITION_ID_DEPLOY}
      # Client secret for the Benchling App, stored somewhere securely in production.
      # Injected here for convenience. Each Client ID will have its own Client secret
      - CLIENT_SECRET_FILE=/run/secrets/app_client_secret
      - APP_ENV=deploy
    secrets:
      - app_client_secret
    networks:
      - canvas-net

  # nginx:
  #   image: nginx:latest
  #   ports:
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - /opt/cert/chained.pem:/etc/ssl/certs/chained.pem:ro
  #     - /opt/cert/domain.key:/etc/ssl/private/domain.key:ro
  #   depends_on:
  #     - benchling-app
  # FOR LOCAL DEVELOPMENT ONLY!
  # Free tool for providing a public URL to forward webhooks to our Benchling App running locally
  # Do not do this in production or use with any sensitive data.
  # Benchling has not vetted this tool for use in production or in sensitive systems.
  # Conduct your own due diligence before choosing a tool for production use.
  # cloudflare-tunnel:
  #   image: cloudflare/cloudflared
  #   restart: unless-stopped
  #   command: tunnel --url http://benchling-app:5000

  # Since were are using ngrok:
  # ngrok:
  #   image: ngrok/ngrok:latest
  #   restart: unless-stopped
  #   command: http benchling-app:5000
  #   environment:
  #     - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}


secrets:
  app_client_secret:
    file: .client_secret_deploy.txt

networks:
  canvas-net:
    external: true